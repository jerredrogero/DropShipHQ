{% extends 'core/base.html' %}
{% load static %}
{% load form_tags %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'core/css/dashboard.css' %}">
<style>
    .edit-mode .editable {
        background-color: #fff3cd;
        padding: 2px;
        border: 1px solid #ffeeba;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Date range and search form -->
    <form method="get" class="mb-4">
        <div class="row">
            <div class="col-md-3">
                <label for="start_date">Start Date:</label>
                <input type="date" id="start_date" name="start_date" class="form-control" value="{{ start_date|date:'Y-m-d' }}">
            </div>
            <div class="col-md-3">
                <label for="end_date">End Date:</label>
                <input type="date" id="end_date" name="end_date" class="form-control" value="{{ end_date|date:'Y-m-d' }}">
            </div>
            <div class="col-md-4">
                <label for="search">Search:</label>
                <input type="text" id="search" name="search" class="form-control" value="{{ search_query }}" placeholder="Order #, Tracking #, or Product">
            </div>
            <div class="col-md-2 align-self-end">
                <button type="submit" class="btn btn-primary w-100">Apply</button>
            </div>
        </div>
    </form>

    <!-- Summary section -->
    <h3 class="mb-3">Summary {% if is_filtered %}(Filtered: {{ start_date|date:"M d, Y" }} - {{ end_date|date:"M d, Y" }}){% endif %}</h3>
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-4 g-4 mb-4">
        <div class="col">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Total Cost</h5>
                    <p class="card-text">${{ summary.total_cost|default:"0.00"|floatformat:2 }}</p>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Total Reimbursed</h5>
                    <p class="card-text">${{ summary.total_reimbursed|default:"0.00"|floatformat:2 }}</p>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Total Cash Back</h5>
                    <p class="card-text">${{ summary.total_cash_back|default:"0.00"|floatformat:2 }}</p>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Total Profit</h5>
                    <p class="card-text">${{ summary.total_profit|default:"0.00"|floatformat:2 }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Order creation form -->
    <div class="card mb-4 add-new-order">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0 fs-5">Add New Order</h3>
        </div>
        <div class="card-body">
            <form method="post" class="row g-2">
                {% csrf_token %}
                {% for field in form %}
                <div class="col-md-4 col-lg-3">
                    <div class="form-group">
                        <label for="{{ field.id_for_label }}" class="form-label small">{{ field.label }}</label>
                        {% if field.field.widget.input_type == 'checkbox' %}
                            <div class="form-check">
                                {{ field }}
                                <label class="form-check-label small" for="{{ field.id_for_label }}">{{ field.label }}</label>
                            </div>
                        {% else %}
                            {{ field|add_class:"form-control form-control-sm" }}
                        {% endif %}
                        {% if field.errors %}
                        <div class="invalid-feedback d-block small">
                            {{ field.errors|join:", " }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                <div class="col-12 mt-3">
                    <button type="submit" class="btn btn-success">Create Order</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Orders table -->
    <h2 class="mt-4">Your Orders</h2>
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Buying Group</th>
                    <th>Account</th>
                    <th>Order Number</th>
                    <th>Tracking Number</th>
                    <th>Product</th>
                    <th>Merchant</th>
                    <th>Card</th>
                    <th>Cost</th>
                    <th>Reimbursed</th>
                    <th>Cash Back</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                <tr id="order-{{ order.id }}">
                    <td><input type="date" class="editable form-control" data-field="date" value="{{ order.date|date:'Y-m-d' }}" disabled></td>
                    <td>
                        <select class="editable form-control" data-field="buying_group" disabled>
                            <option value="">---------</option>
                            {% for group in buying_groups %}
                                <option value="{{ group.id }}" {% if order.buying_group_id == group.id %}selected{% endif %}>{{ group.name }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <select class="editable form-control" data-field="account" disabled>
                            <option value="">---------</option>
                            {% for account in accounts %}
                                <option value="{{ account.id }}" {% if order.account_id == account.id %}selected{% endif %}>{{ account.name }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td><input type="text" class="editable form-control" data-field="order_number" value="{{ order.order_number }}" disabled></td>
                    <td><input type="text" class="editable form-control" data-field="tracking_number" value="{{ order.tracking_number }}" disabled></td>
                    <td><input type="text" class="editable form-control" data-field="product" value="{{ order.product }}" disabled></td>
                    <td>
                        <select class="editable form-control" data-field="merchant" disabled>
                            <option value="">---------</option>
                            {% for merchant in merchants %}
                                <option value="{{ merchant.id }}" {% if order.merchant_id == merchant.id %}selected{% endif %}>{{ merchant.name }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <select class="editable form-control" data-field="card" disabled>
                            <option value="">---------</option>
                            {% for card in cards %}
                                <option value="{{ card.id }}" {% if order.card_id == card.id %}selected{% endif %}>{{ card.name }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td><input type="number" step="0.01" class="editable form-control" data-field="cost" value="{{ order.cost }}" disabled></td>
                    <td><input type="number" step="0.01" class="editable form-control" data-field="reimbursed" value="{{ order.reimbursed }}" disabled></td>
                    <td><input type="number" step="0.01" class="editable form-control" data-field="cash_back" value="{{ order.cash_back }}" disabled></td>
                    <td>
                        <button class="btn btn-sm btn-primary edit-order" data-order-id="{{ order.id }}">Edit</button>
                        <button class="btn btn-sm btn-danger delete-order" data-order-id="{{ order.id }}">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    // Function to show toast notification
    function showToast(message, type = 'success') {
        var toast = $('<div class="toast" role="alert" aria-live="assertive" aria-atomic="true">')
            .addClass('bg-' + (type === 'success' ? 'success' : 'danger'))
            .addClass('text-white')
            .css({
                position: 'fixed',
                top: '20px',
                right: '20px',
                'min-width': '200px',
                'z-index': 9999
            })
            .append($('<div class="toast-body">').text(message));

        $('body').append(toast);
        toast.toast({ delay: 3000 }).toast('show');
    }

    // Edit button click handler
    $('.edit-order').click(function(e) {
        e.preventDefault();
        var orderId = $(this).data('order-id');
        var row = $('#order-' + orderId);
        
        console.log('Edit button clicked for order:', orderId);
        
        // Check if already in edit mode
        if (row.hasClass('edit-mode')) {
            console.log('Already in edit mode, saving...');
            saveOrder(orderId);
        } else {
            console.log('Entering edit mode');
            // Enter edit mode
            row.addClass('edit-mode');
            
            // Make fields editable
            row.find('.editable').prop('disabled', false);
            
            // Change button text
            $(this).text('Save');
            
            // Add a cancel button
            $(this).after('<button class="btn btn-sm btn-secondary cancel-edit ml-2" data-order-id="' + orderId + '">Cancel</button>');
            
            showToast('Editing order. Click Save when done.', 'info');
        }
    });

    // Cancel button click handler
    $(document).on('click', '.cancel-edit', function(e) {
        e.preventDefault();
        var orderId = $(this).data('order-id');
        exitEditMode(orderId);
        showToast('Edit cancelled', 'info');
    });

    function exitEditMode(orderId) {
        var row = $('#order-' + orderId);
        
        console.log('Exiting edit mode for order:', orderId);
        
        // Remove edit mode class
        row.removeClass('edit-mode');
        
        // Revert fields to non-editable
        row.find('.editable').prop('disabled', true);
        
        // Change button back to "Edit"
        row.find('.edit-order').text('Edit');
        
        // Remove the cancel button
        row.find('.cancel-edit').remove();
    }

    function saveOrder(orderId) {
        var row = $('#order-' + orderId);
        var data = {};
        row.find('.editable').each(function() {
            var field = $(this).data('field');
            var value = $(this).val();
            data[field] = value;
        });

        $.ajax({
            url: '/edit-order/' + orderId + '/',
            method: 'POST',
            data: data,
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            success: function(response) {
                if (response.success) {
                    showToast('Order updated successfully', 'success');
                    exitEditMode(orderId);
                    // Update the row with new values
                    updateRowValues(row, data);
                } else {
                    showToast('Error saving order: ' + JSON.stringify(response.errors), 'error');
                }
            },
            error: function(xhr, status, error) {
                showToast('Error saving order: ' + error, 'error');
            }
        });
    }

    function updateRowValues(row, data) {
        for (var field in data) {
            var element = row.find('[data-field="' + field + '"]');
            if (element.is('select')) {
                element.val(data[field]);
            } else {
                element.val(data[field]);
            }
        }
    }

    // Delete button click handler
    $('.delete-order').click(function() {
        var orderId = $(this).data('order-id');
        if (confirm('Are you sure you want to delete this order?')) {
            $.ajax({
                url: '/delete-order/' + orderId + '/',
                method: 'POST',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                success: function(response) {
                    if (response.success) {
                        showToast('Order deleted successfully', 'success');
                        location.reload(); // Refresh the page after successful delete
                    } else {
                        showToast('Error deleting order', 'error');
                    }
                },
                error: function() {
                    showToast('Error deleting order', 'error');
                }
            });
        }
    });
});
</script>
{% endblock %}